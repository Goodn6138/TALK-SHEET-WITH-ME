<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: Arial; padding: 20px; }
    textarea, input { width: 100%; margin: 5px 0; }
    button { padding: 10px; margin: 5px; }
    #recordingIndicator { color: red; font-weight: bold; display: none; }
    #status { margin-top: 10px; padding: 10px; border-radius: 5px; }
    .success { background-color: #d4edda; color: #155724; }
    .error { background-color: #f8d7da; color: #721c24; }
    .loading { background-color: #fff3cd; color: #856404; }
  </style>
</head>
<body>
  <h2>SHEET TALK 😊</h2>
  <textarea id="textInput" placeholder="Type or speak your command... (e.g., 'Sum all values in column A', 'Create a chart from data in A1:B10')" rows="3"></textarea>
  <br>
  <button onclick="startListening()">🎙 Speak</button>
  <button onclick="sendToServer()">📤 Send Command</button>
  <button onclick="clearInput()">🗑 Clear</button>
  
  <div id="recordingIndicator">🔴 Listening...</div>
  <div id="status"></div>

  <script>
    let recognition;
    
    function startListening() {
      const indicator = document.getElementById("recordingIndicator");
      try {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.lang = 'en-US';
        recognition.continuous = false;
        recognition.interimResults = false;
        
        recognition.start();
        indicator.style.display = "block";

        recognition.onresult = function(event) {
          const transcript = event.results[0][0].transcript;
          document.getElementById("textInput").value = transcript;
          indicator.style.display = "none";
        };
        
        recognition.onend = () => { 
          indicator.style.display = "none"; 
        };
        
        recognition.onerror = (event) => {
          indicator.style.display = "none";
          updateStatus("Speech recognition error: " + event.error, "error");
        };
        
      } catch (err) {
        indicator.style.display = "none";
        alert("Speech recognition not supported in this browser.");
      }
    }

    function clearInput() {
      document.getElementById("textInput").value = "";
      document.getElementById("status").innerHTML = "";
    }

    function updateStatus(message, type = "loading") {
      const statusDiv = document.getElementById("status");
      statusDiv.innerHTML = message;
      statusDiv.className = type;
    }

    async function sendToServer() {
      const text = document.getElementById("textInput").value.trim();
      if (!text) {
        updateStatus("Please provide a command first.", "error");
        return;
      }

      updateStatus("⏳ Processing your command...", "loading");

      try {
        
        const SERVER_URL = "https://your-server.onrender.com"; // Update this!
        
        const response = await fetch(`${SERVER_URL}/parse-command`, {
          method: "POST",
          headers: { 
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ 
            input: text,
            context: "Google Sheets spreadsheet operation"
          })
        });

        if (!response.ok) {
          throw new Error(`Server error: ${response.status}`);
        }

        const json = await response.json();
        
        if (json.status === "success" && json.script) {
          updateStatus("🔄 Executing script in spreadsheet...", "loading");
          
          // Execute the script
          google.script.run
            .withSuccessHandler(result => {
              updateStatus(`✅ ${result}`, "success");
            })
            .withFailureHandler(error => {
              updateStatus(`❌ Execution Error: ${error.message}`, "error");
            })
            .executeDynamicScript(json.script);
            
        } else {
          updateStatus(`❌ Server Error: ${json.error || 'Unknown error'}`, "error");
        }
        
      } catch (err) {
        updateStatus(`❌ Failed to contact server: ${err.message}`, "error");
        console.error("Fetch error:", err);
      }
    }

    // Allow Enter key to send command
    document.getElementById("textInput").addEventListener("keypress", function(event) {
      if (event.key === "Enter" && !event.shiftKey) {
        event.preventDefault();
        sendToServer();
      }
    });
  </script>
</body>
</html>